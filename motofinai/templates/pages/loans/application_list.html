{% extends "layouts/base.html" %}

{% block title %}Loan Applications{% endblock title %}

{% block content %}
  <div class="mx-auto max-w-5xl px-4 py-10">
    <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h1 class="text-2xl font-semibold text-slate-900">Loan applications</h1>
        <p class="mt-1 text-sm text-slate-600">Track submissions and progress through approval.</p>
      </div>
      <div class="flex gap-2">
        <a
          href="{% url 'loans:export' %}{% if search_query %}?search={{ search_query }}{% endif %}"
          class="inline-flex items-center justify-center gap-2 rounded-md border border-slate-300 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm transition hover:bg-slate-50"
        >
          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          Export CSV
        </a>
        <a
          href="{% url 'loans:new' %}"
          class="inline-flex items-center justify-center rounded-md bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-sky-700"
        >
          New application
        </a>
      </div>
    </div>

    <!-- Search and Filter Controls -->
    <div class="mt-6 rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
      <div class="grid gap-4 sm:grid-cols-3">
        <!-- Search Input -->
        <div class="sm:col-span-2">
          <label for="search-input" class="text-xs font-semibold uppercase tracking-wide text-slate-500">Search</label>
          <div class="relative mt-1">
            <input
              type="text"
              id="search-input"
              name="q"
              value="{{ search_query }}"
              placeholder="Search by applicant name, email, phone, or motorcycle..."
              class="block w-full rounded-md border border-slate-300 px-4 py-2 pr-10 text-sm focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500"
              hx-get="{% url 'loans:list' %}"
              hx-trigger="keyup changed delay:300ms, search"
              hx-target="#application-table-container"
              hx-swap="innerHTML"
              hx-include="[name='status']"
              hx-indicator="#search-indicator"
            />
            <div id="search-indicator" class="htmx-indicator absolute inset-y-0 right-0 flex items-center pr-3">
              <svg class="h-4 w-4 animate-spin text-sky-600" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </div>
          </div>
        </div>

        <!-- Status Filter -->
        <div>
          <label for="status-filter" class="text-xs font-semibold uppercase tracking-wide text-slate-500">Status</label>
          <select
            id="status-filter"
            name="status"
            class="mt-1 block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500"
            hx-get="{% url 'loans:list' %}"
            hx-trigger="change"
            hx-target="#application-table-container"
            hx-swap="innerHTML"
            hx-include="[name='q']"
            hx-indicator="#search-indicator"
          >
            {% for value, label in filter_choices.status %}
              <option value="{{ value }}" {% if current_filters.status == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- Active Filters Display -->
      {% if search_query or current_filters.status %}
        <div class="mt-4 flex flex-wrap items-center gap-2 border-t border-slate-100 pt-4">
          <span class="text-xs font-medium text-slate-500">Active filters:</span>
          {% if search_query %}
            <span class="inline-flex items-center rounded-full bg-sky-100 px-2.5 py-0.5 text-xs font-medium text-sky-800">
              Search: "{{ search_query }}"
              <button
                type="button"
                class="ml-1 text-sky-600 hover:text-sky-800"
                onclick="document.getElementById('search-input').value=''; htmx.trigger('#search-input', 'search')"
              >
                <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </span>
          {% endif %}
          {% if current_filters.status %}
            <span class="inline-flex items-center rounded-full bg-sky-100 px-2.5 py-0.5 text-xs font-medium text-sky-800">
              Status: {{ current_filters.status }}
              <button
                type="button"
                class="ml-1 text-sky-600 hover:text-sky-800"
                onclick="document.getElementById('status-filter').value=''; htmx.trigger('#status-filter', 'change')"
              >
                <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </span>
          {% endif %}
          <a
            href="{% url 'loans:list' %}"
            class="text-xs font-medium text-slate-600 hover:text-slate-900 ml-2"
          >
            Clear all
          </a>
        </div>
      {% endif %}
    </div>

    <!-- Table Container -->
    <div id="application-table-container" class="mt-4 overflow-hidden rounded-lg border border-slate-200 bg-white shadow-sm">
      {% include "pages/loans/_application_table.html" %}
    </div>

    {% if is_paginated %}
      <div class="mt-4 flex items-center justify-between border-t border-slate-200 bg-white px-4 py-3 rounded-lg text-sm text-slate-600">
        <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        <div class="flex items-center gap-2">
          {% if page_obj.has_previous %}
            <a
              href="?page={{ page_obj.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if current_filters.status %}&status={{ current_filters.status }}{% endif %}{% if current_sort %}&sort={{ current_sort }}&order={{ current_order }}{% endif %}"
              hx-get="?page={{ page_obj.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if current_filters.status %}&status={{ current_filters.status }}{% endif %}{% if current_sort %}&sort={{ current_sort }}&order={{ current_order }}{% endif %}"
              hx-target="#application-table-container"
              hx-swap="innerHTML"
              class="text-sky-600 hover:text-sky-700"
            >
              Previous
            </a>
          {% endif %}
          {% if page_obj.has_next %}
            <a
              href="?page={{ page_obj.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if current_filters.status %}&status={{ current_filters.status }}{% endif %}{% if current_sort %}&sort={{ current_sort }}&order={{ current_order }}{% endif %}"
              hx-get="?page={{ page_obj.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if current_filters.status %}&status={{ current_filters.status }}{% endif %}{% if current_sort %}&sort={{ current_sort }}&order={{ current_order }}{% endif %}"
              hx-target="#application-table-container"
              hx-swap="innerHTML"
              class="text-sky-600 hover:text-sky-700"
            >
              Next
            </a>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>
{% endblock content %}
